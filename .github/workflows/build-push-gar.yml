name: Build & Push Microservices Images

on:
  push:
    branches:
      - main

########################################
# Cancel old runs if new commit pushed
########################################
concurrency:
  group: build-main
  cancel-in-progress: true

permissions:
  id-token: write
  contents: read

env:
  REGION: asia-south2
  PROJECT_ID: emerald-oath-480315-m9
  REPOSITORY: demo-repo

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - name: application-service
            context: ./application-service
          - name: order-service
            context: ./order-service
          - name: patient-service
            context: ./patient-service

    steps:
    ########################################
    # Checkout
    ########################################
    - name: Checkout Code
      uses: actions/checkout@v4

    ########################################
    # Docker Buildx (faster builds)
    ########################################
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    ########################################
    # Authenticate (SAME as your existing)
    ########################################
    - name: Authenticate to Google Cloud
      id: auth
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: projects/13644095870/locations/global/workloadIdentityPools/github-pool-v2/providers/github-provider
        service_account: github-wif@emerald-oath-480315-m9.iam.gserviceaccount.com

    ########################################
    # Docker login (better than gcloud configure)
    ########################################
    - name: Login to Artifact Registry
      uses: docker/login-action@v3
      with:
        registry: asia-south2-docker.pkg.dev
        username: oauth2accesstoken
        password: ${{ steps.auth.outputs.access_token }}

    ########################################
    # Generate ONE version tag
    ########################################
    - name: Generate version tag
      id: version
      run: |
        SHORT_SHA=$(git rev-parse --short=7 HEAD)
        FULL_SHA=$(git rev-parse HEAD)

        echo "tag=v1.0.$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "sha=$FULL_SHA" >> $GITHUB_OUTPUT

    ########################################
    # Build & Push each microservice
    ########################################
    - name: Build & Push ${{ matrix.service.name }}
      uses: docker/build-push-action@v5
      with:
        context: ${{ matrix.service.context }}
        file: ${{ matrix.service.context }}/Dockerfile
        push: true

        tags: |
          ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ matrix.service.name }}:${{ steps.version.outputs.tag }}

        labels: |
          org.opencontainers.image.revision=${{ steps.version.outputs.sha }}
          org.opencontainers.image.source=${{ github.repository }}

        cache-from: type=gha,scope=${{ matrix.service.name }}
        cache-to: type=gha,mode=max,scope=${{ matrix.service.name }}

    ########################################
    # Output
    ########################################
    - name: Done
      run: |
        echo "âœ… All services pushed with tag ${{ steps.version.outputs.tag }}"
