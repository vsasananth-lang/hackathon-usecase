name: Build & Push Microservices Images

on:
  push:
    branches:
      - main

############################################
# Cancel older runs if a new commit comes
############################################
concurrency:
  group: build-main
  cancel-in-progress: true

env:
  REGION: asia-south2
  PROJECT_ID: emerald-oath-480315-m9
  REPOSITORY: demo-repo

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        service:
          - name: application-service
            context: ./application-service
          - name: order-service
            context: ./order-service
          - name: patient-service
            context: ./patient-service

    steps:
    ########################################
    # Checkout source
    ########################################
    - name: Checkout
      uses: actions/checkout@v4

    ########################################
    # Install gcloud (runner usually has it,
    # but this keeps things reliable)
    ########################################
    - name: Setup gcloud
      uses: google-github-actions/setup-gcloud@v2

    ########################################
    # Create service account JSON file
    ########################################
    - name: Create GCP key file
      run: |
        echo '${{ secrets.GCP_GAR }}' > "${{ github.workspace }}/gcp-key.json"

    ########################################
    # Authenticate using service account key
    ########################################
    - name: Authenticate gcloud
      run: |
        gcloud auth activate-service-account --key-file=gcp-key.json
        gcloud config set project $PROJECT_ID

    ########################################
    # Configure Docker for Artifact Registry
    ########################################
    - name: Configure Docker auth
      run: |
        gcloud auth configure-docker $REGION-docker.pkg.dev --quiet

    ########################################
    # Generate single immutable version tag
    ########################################
    - name: Generate version tag
      id: version
      run: |
        SHORT_SHA=$(git rev-parse --short=7 HEAD)
        echo "tag=v1.0.$SHORT_SHA" >> $GITHUB_OUTPUT

    ########################################
    # Build & Push each microservice
    ########################################
    - name: Build & Push ${{ matrix.service.name }}
      run: |
        IMAGE=$REGION-docker.pkg.dev/$PROJECT_ID/$REPOSITORY/${{ matrix.service.name }}:${{ steps.version.outputs.tag }}

        echo "ðŸš€ Building $IMAGE"
        docker build -t $IMAGE ${{ matrix.service.context }}

        echo "ðŸ“¦ Pushing $IMAGE"
        docker push $IMAGE

    ########################################
    # Cleanup key file (security best practice)
    ########################################
    - name: Cleanup key file
      run: rm -f gcp-key.json

    ########################################
    # Done message
    ########################################
    - name: Done
      run: echo "âœ… All services pushed with tag ${{ steps.version.outputs.tag }}"
